<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Créer une équipe - PEPECO</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --red-bg: #d01818;
            --red-bg-gradient: linear-gradient(135deg, #d01818, #a21010);
            --green: #61B604;
            --green-dark: #5aaf04;
            --gray-light: #f1f3f5;
            --gray-medium: #cacaca;
            --white: #ffffff;
            --radius: 16px;
            --padding: 16px;
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--font-family);
        }
        
        body {
            background: var(--red-bg-gradient);
            color: var(--white);
            line-height: 1.6;
            padding: 16px;
            min-height: 100vh;
            padding-bottom: 80px; /* Espace pour la nav fixe */
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
        }
        
        .header {
            margin-bottom: 24px;
            text-align: center;
        }
        
        h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            text-shadow: 0 0 12px rgba(0,0,0,0.6);
        }
        
        .team-link {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .invitation-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            color: #000;
        }
        
        .code-section {
            margin-bottom: 20px;
        }
        
        .code-label {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 4px;
        }
        
        .code-display {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--green);
            background: var(--gray-light);
            padding: 12px 16px;
            border-radius: 10px;
            border: 1px solid var(--gray-medium);
            word-break: break-all;
        }
        
        .link-section {
            margin-bottom: 20px;
        }
        
        .link-display {
            font-size: 14px;
            color: var(--green);
            word-break: break-all;
            margin-bottom: 8px;
            background: var(--gray-light);
            padding: 12px 16px;
            border-radius: 10px;
            border: 1px solid var(--gray-medium);
        }
        
        .action-buttons {
            display: flex;
            gap: 12px;
        }
        
        .btn {
            flex: 1;
            padding: 14px 16px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-copy {
            background-color: var(--gray-light);
            color: #374151;
            border: 1px solid var(--gray-medium);
        }
        
        .btn-copy:hover {
            background-color: #e5e7eb;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        /* NOUVEAU : Carte pour afficher le solde */
        .balance-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            color: #000;
            text-align: center;
        }
        
        .balance-amount {
            font-size: 32px;
            font-weight: 700;
            color: var(--green);
            margin: 10px 0;
        }
        
        .balance-label {
            font-size: 14px;
            color: #6b7280;
        }
        
        .stats-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            color: #000;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stats-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 24px;
        }
        
        .stat-item {
            text-align: center;
            flex: 1;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--green);
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #6b7280;
        }
        
        .btn-team {
            width: 100%;
            padding: 16px;
            background: var(--green);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-team:hover {
            background: var(--green-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(97, 182, 4, 0.3);
        }
        
        .info-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            color: #000;
        }
        
        .info-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .info-content {
            color: #4b5563;
            line-height: 1.7;
            font-size: 15px;
        }
        
        .highlight {
            color: var(--green);
            font-weight: 600;
        }
        
        .divider {
            height: 1px;
            background: var(--gray-medium);
            margin: 20px 0;
        }
        
        .icon {
            color: var(--green);
        }

        /* Modal pour voir les équipes */
        .team-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1002;
            padding: 20px;
        }

        .team-modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius);
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            background: var(--green);
            color: white;
            padding: 20px;
            border-radius: var(--radius) var(--radius) 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 20px;
        }

        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 20px;
        }

        .team-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--gray-medium);
        }

        .team-stat {
            text-align: center;
            padding: 15px;
            background: var(--gray-light);
            border-radius: var(--radius);
        }

        .team-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--green);
            margin-bottom: 5px;
        }

        .team-stat-label {
            font-size: 14px;
            color: #6b7280;
        }

        .members-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .member-card {
            background: white;
            border: 1px solid var(--gray-medium);
            border-radius: var(--radius);
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .member-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--green);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
        }

        .member-name {
            font-weight: 600;
            color: #1f2937;
        }

        .member-date {
            font-size: 12px;
            color: #6b7280;
        }

        .member-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .member-stat {
            text-align: center;
            padding: 8px;
            background: var(--gray-light);
            border-radius: 8px;
        }

        .member-stat-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .member-stat-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--green);
        }

        .no-team-message {
            text-align: center;
            padding: 40px 20px;
            color: #6b7280;
        }

        .no-team-message i {
            font-size: 48px;
            margin-bottom: 15px;
            color: var(--gray-medium);
        }

        /* Bottom nav fixe */
        nav.bottom-nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            z-index: 1000;
            margin-top: auto;
            display: flex;
            background-color: var(--green);
            color: var(--white);
            font-weight: 700;
            font-size: 16px;
            border-radius: var(--radius) var(--radius) 0 0;
            overflow: hidden;
            user-select: none;
            left: 0;
        }

        nav.bottom-nav a {
            flex: 1;
            text-align: center;
            padding: 14px 0;
            cursor: pointer;
            transition: background-color 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            color: inherit;
            text-decoration: none;
        }

        nav.bottom-nav a.active {
            background-color: var(--white);
            color: var(--green);
            border-radius: var(--radius) var(--radius) 0 0;
        }

        nav.bottom-nav a:not(.active):hover {
            background-color: #87d544;
        }

        nav.bottom-nav svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        /* Styles pour les champs cachés */
        .hidden-input {
            position: absolute;
            left: -9999px;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--green);
            color: white;
            padding: 12px 20px;
            border-radius: var(--radius);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1001;
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Créer une équipe</h1>
            <div class="team-link">
                <i class="fas fa-chevron-right"></i>
                <span>Mon équipe</span>
            </div>
        </div>
        
        
        
        <div class="invitation-card">
            <div class="code-section">
                <div class="code-label">Code d'invitation</div>
                <div class="code-display" id="referralCodeDisplay">Chargement</div>
            </div>
            
            <div class="link-section">
                <div class="code-label">Lien d'invitation</div>
                <div class="link-display" id="referralLinkDisplay"chargement </div>
            </div>
            
            <div class="divider"></div>
            
            <div class="action-buttons">
                <button class="btn btn-copy" id="copyReferralCodeBtn">
                    <i class="far fa-copy"></i>
                    Copier le code
                </button>
                <button class="btn btn-copy" id="copyReferralLinkBtn">
                    <i class="fas fa-link"></i>
                    Copier le lien
                </button>
            </div>

            <!-- Champs cachés pour la copie -->
            <input type="text" id="referralCode" class="hidden-input" value="DRN80X">
            <input type="text" id="referralLink" class="hidden-input" value="https://omni-vroa.com/reg?code=DRN80X">
        </div>
        
        <div class="stats-card">
            <div class="section-title">
                <i class="fas fa-gift icon"></i>
                Bonus de parrainage
            </div>
            
            <div class="stats-container">
                <div class="stat-item">
                    <div class="stat-value" id="totalBonus">0 FCFA</div>
                    <div class="stat-label">Total des bonus</div>
                </div>
                
                <div class="stat-item">
                    <div class="stat-value" id="teamCount">0</div>
                    <div class="stat-label">Nombre de l'équipe</div>
                </div>
            </div>
            
            <button class="btn-team" id="showTeamButton">
                <i class="fas fa-users"></i>
                Voir mes équipes
            </button>
        </div>
        
        <div class="info-card">
            <div class="info-title">
                <i class="fas fa-info-circle icon"></i>
                Comment parrainer
            </div>
            
            <div class="info-content">
                <p>En invitant un ami à s'inscrire et à investir, vous recevrez instantanément un <span class="highlight">bonus de 27%</span> de son investissement.</p>
                
                <p>Une fois l'investissement de votre filleul effectué, vous recevez le bonus automatiquement.</p>
            </div>
        </div>
    </div>

    <!-- Modal pour voir les équipes -->
    <div class="team-modal" id="teamModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Mes équipes</h2>
                <button class="close-modal" id="closeTeamModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="team-stats">
                    <div class="team-stat">
                        <div class="team-stat-value" id="teamCountModal">0</div>
                        <div class="team-stat-label">Membres total</div>
                    </div>
                    <div class="team-stat">
                        <div class="team-stat-value" id="totalBonusModal">0 FCFA</div>
                        <div class="team-stat-label">Total des bonus</div>
                    </div>
                </div>
                <div class="members-list" id="teamMembersContainer">
                    <!-- Les membres de l'équipe seront ajoutés ici dynamiquement -->
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <!-- Navigation en bas -->
    <nav class="bottom-nav" role="navigation" aria-label="Navigation principale">
        <a href="accueil.html" class="active" aria-current="page">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" /></svg>
            Accueil
        </a>
        <a href="appareil.html">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 6H4v12h16V6z" /></svg>
            Article 
        </a>
        <a href="equipe.html">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4z" /></svg>
            Équipe
        </a>
        <a href="solde.html">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4v-1H8v1c0 2.21 1.79 4 4 4z" /></svg>
            Moi
        </a>
    </nav>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword
  } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
  import {
    getDatabase,
    ref,
    get,
    set,
    update,
    onValue,
    runTransaction,
    query,
    orderByChild,
    equalTo
  } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

  // 🔥 Configuration Firebase (PEPECO)
  const firebaseConfig = {
    apiKey: "AIzaSyCaDZQUirunG7CPrMISasgBVlVgkyuISko",
    authDomain: "pepeco-f6f26.firebaseapp.com",
    databaseURL: "https://pepeco-f6f26-default-rtdb.firebaseio.com",
    projectId: "pepeco-f6f26",
    storageBucket: "pepeco-f6f26.firebasestorage.app",
    messagingSenderId: "175958489677",
    appId: "1:175958489677:web:48b339d732e4207d0f7a04"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const database = getDatabase(app);

  let currentUser = null;

  // Éléments DOM
  const elements = {
    showTeamButton: document.getElementById('showTeamButton'),
    closeTeamModalBtn: document.getElementById('closeTeamModalBtn'),
    copyReferralCodeBtn: document.getElementById('copyReferralCodeBtn'),
    copyReferralLinkBtn: document.getElementById('copyReferralLinkBtn'),
    teamModal: document.getElementById('teamModal'),
    teamMembersContainer: document.getElementById('teamMembersContainer'),
    teamCount: document.getElementById('teamCount'),
    teamCountModal: document.getElementById('teamCountModal'),
    totalBonus: document.getElementById('totalBonus'),
    totalBonusModal: document.getElementById('totalBonusModal'),
    referralCodeDisplay: document.getElementById('referralCodeDisplay'),
    referralLinkDisplay: document.getElementById('referralLinkDisplay'),
    userBalanceDisplay: document.getElementById('userBalanceDisplay')
  };

  // 🔧 Fonctions utilitaires
  const utils = {
    formatCurrency: (amount) => {
      if (typeof amount !== 'number' || isNaN(amount)) return "0 FCFA";
      return amount.toLocaleString('fr-FR', { minimumFractionDigits: 0 }) + ' FCFA';
    },
    formatDate: (dateString) => {
      if (!dateString) return "Date inconnue";
      try {
        return new Date(dateString).toLocaleDateString('fr-FR', { year: 'numeric', month: 'long', day: 'numeric' });
      } catch (e) {
        return "Date inconnue";
      }
    },
    copyToClipboard: async (elementId) => {
      try {
        const element = document.getElementById(elementId);
        await navigator.clipboard.writeText(element.value || element.textContent);
        alert('Copié avec succès !');
      } catch (err) {
        alert('Erreur lors de la copie.');
      }
    }
  };

  // 🧠 Classe principale : gestion des bonus
  class BonusSystem {

    static async displayTotalBonus() {
      if (!currentUser) return;

      try {
        const userRef = ref(database, `users/${currentUser.uid}`);
        const userSnap = await get(userRef);

        if (!userSnap.exists()) return;

        const userData = userSnap.val();
        const fields = ['totalReferralBonus', 'referralBonus', 'totalBonus', 'bonus', 'commission', 'earnings', 'totalEarnings'];

        let totalBonus = 0;
        for (const field of fields) {
          if (userData[field] !== undefined && userData[field] !== null) {
            totalBonus = parseFloat(userData[field]) || 0;
            break;
          }
        }

        if (totalBonus > 0) {
          await this.creditBonusToBalance(totalBonus);
        } else {
          this.updateBonusDisplay(0);
        }

      } catch (error) {
        console.error("Erreur bonus:", error);
      }
    }

    static async creditBonusToBalance(bonusAmount) {
      if (!currentUser || bonusAmount <= 0) return;

      const userRef = ref(database, `users/${currentUser.uid}`);

      try {
        await runTransaction(userRef, (userData) => {
          if (userData) {
            const balance = parseFloat(userData.balance) || 0;
            const newBalance = balance + bonusAmount;

            userData.balance = newBalance;
            userData.bonusCredited = true;
            userData.bonusCreditedAmount = bonusAmount;
            userData.lastBonusCredit = new Date().toISOString();

            this.updateBonusDisplay(bonusAmount);
          }
          return userData;
        });
      } catch (error) {
        console.error("Erreur crédit bonus:", error);
      }
    }

    static updateBonusDisplay(totalBonus) {
      if (elements.totalBonus) elements.totalBonus.textContent = utils.formatCurrency(totalBonus);
      if (elements.totalBonusModal) elements.totalBonusModal.textContent = utils.formatCurrency(totalBonus);
    }
  }

  // 🧭 Gestion du chargement en temps réel
  class DataMonitor {
    static start() {
      if (!currentUser) return;

      const userRef = ref(database, `users/${currentUser.uid}`);
      onValue(userRef, (snapshot) => {
        if (!snapshot.exists()) return;

        const data = snapshot.val();
        const fields = ['totalReferralBonus', 'referralBonus', 'totalBonus', 'bonus'];

        for (const field of fields) {
          if (data[field]) {
            BonusSystem.creditBonusToBalance(parseFloat(data[field]));
            break;
          }
        }
      });

      setTimeout(() => BonusSystem.displayTotalBonus(), 1500);
    }
  }

  // 🎨 Mise à jour interface utilisateur
  const updateUI = {
    loadUserBalance: () => {
      if (!currentUser) return;
      onValue(ref(database, `users/${currentUser.uid}/balance`), (snapshot) => {
        const balance = snapshot.val() || 0;
        if (elements.userBalanceDisplay) {
          elements.userBalanceDisplay.textContent = utils.formatCurrency(balance);
        }
      });
    },

    loadTeamMembers: () => {
      if (!currentUser) return;

      const teamQuery = query(ref(database, 'users'), orderByChild('referredBy'), equalTo(currentUser.uid));
      onValue(teamQuery, (snapshot) => {
        const members = [];
        if (snapshot.exists()) {
          snapshot.forEach((snap) => members.push({ ...snap.val(), uid: snap.key }));
        }

        if (elements.teamCount) elements.teamCount.textContent = members.length;
        if (elements.teamCountModal) elements.teamCountModal.textContent = members.length;

        if (!elements.teamMembersContainer) return;

        if (members.length === 0) {
          elements.teamMembersContainer.innerHTML = `
            <div class="no-team-message">
              <i class="fas fa-users-slash"></i>
              <h3>Aucun membre dans votre équipe</h3>
              <p>Parrainez des amis pour les voir ici.</p>
            </div>`;
        } else {
          elements.teamMembersContainer.innerHTML = members.map(member => `
            <div class="member-card">
              <div class="member-header">
                <div class="member-avatar">${member.username?.charAt(0).toUpperCase() || '?'}</div>
                <div>
                  <div class="member-name">${member.username || 'Membre'}</div>
                  <div class="member-date">Rejoint le ${utils.formatDate(member.createdAt)}</div>
                </div>
              </div>
              <div class="member-stats">
                <div class="member-stat">
                  <div class="member-stat-label">Total investi</div>
                  <div class="member-stat-value">${utils.formatCurrency(parseFloat(member.totalInvestments) || 0)}</div>
                </div>
              </div>
            </div>`).join('');
        }
      });
    },

    loadReferralInfo: () => {
      if (!currentUser) return;

      onValue(ref(database, `users/${currentUser.uid}`), (snap) => {
        const data = snap.val();
        if (!data) return;

        const code = data.referralCode || "DRN80X";
        const link = `${window.location.origin}/index.html?ref=${code}`;

        if (elements.referralCodeDisplay) elements.referralCodeDisplay.textContent = code;
        if (elements.referralLinkDisplay) elements.referralLinkDisplay.textContent = link;

        const refCode = document.getElementById('referralCode');
        const refLink = document.getElementById('referralLink');
        if (refCode) refCode.value = code;
        if (refLink) refLink.value = link;
      });
    }
  };

  // 🧩 Événements
  const setupEventListeners = () => {
    elements.showTeamButton?.addEventListener('click', () => {
      elements.teamModal?.classList.add('active');
      BonusSystem.displayTotalBonus();
    });

    elements.closeTeamModalBtn?.addEventListener('click', () => {
      elements.teamModal?.classList.remove('active');
    });

    elements.teamModal?.addEventListener('click', (e) => {
      if (e.target === elements.teamModal) {
        elements.teamModal.classList.remove('active');
      }
    });

    elements.copyReferralCodeBtn?.addEventListener('click', () => utils.copyToClipboard('referralCode'));
    elements.copyReferralLinkBtn?.addEventListener('click', () => utils.copyToClipboard('referralLink'));
  };

  // 👤 Authentification
  const handleAuthStateChange = (user) => {
    if (!user) {
      console.log("Utilisateur non connecté");
      return;
    }

    currentUser = user;
    updateUI.loadUserBalance();
    updateUI.loadTeamMembers();
    updateUI.loadReferralInfo();
    DataMonitor.start();
  };

  const initApp = () => {
    console.log("🚀 Initialisation...");
    setupEventListeners();
    onAuthStateChanged(auth, handleAuthStateChange);
  };

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initApp);
  } else {
    initApp();
  }
</script>
</body>
</html>