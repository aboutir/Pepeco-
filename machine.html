<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mes VIPs - Investissements</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet" />
  <style>
    :root {
      --red-bg: #d01818;
      --red-bg-gradient: linear-gradient(135deg, #d01818, #a21010);
      --green: #61B604;
      --green-dark: #5aaf04;
      --gray-light: #f1f3f5;
      --gray-medium: #cacaca;
      --white: #ffffff;
      --radius: 12px;
      --padding: 12px;
      --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      --background-gradient: linear-gradient(135deg, #d01818, #a21010);
      
      --card-gradient-start: #ffffffcc;
      --card-gradient-end: #e0e7ffcc;
    }

    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: var(--font-family);
      background: var(--background-gradient);
      color: var(--white);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-bottom: 62px; /* Pour nav fixe */
      padding-top: 20px;
      background-attachment: fixed;
      background-repeat: no-repeat;
      background-size: cover;
    }
    header {
      text-align: center;
      margin-bottom: 10px;
      text-shadow: 0 0 7px rgba(0,0,0,0.7);
    }
    header h1 {
      margin: 0;
      font-weight: 700;
      color: var(--white);
      font-size: 1.5rem;
      letter-spacing: 0.05em;
    }
    header p {
      font-weight: 400;
      font-size: 0.9rem;
      color: #e0e0e0cc;
      margin-top: 4px;
      font-style: italic;
    }
    .stats {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      width: 100%;
      max-width: 720px;
      justify-content: center;
      padding: 0 var(--padding);
      box-sizing: border-box;
    }
    .stat-box {
      background: linear-gradient(145deg, var(--card-gradient-start), var(--card-gradient-end));
      color: #1e293b;
      padding: 12px 20px;
      border-radius: var(--radius);
      box-shadow: 6px 6px 12px #bebebe, -6px -6px 12px #ffffff;
      flex: 1;
      min-width: 120px;
      text-align: center;
      user-select: none;
      backdrop-filter: blur(6px);
      border: 1px solid rgba(255,255,255,0.25);
    }
    .stat-box span.number {
      font-size: 1.6rem;
      font-weight: 800;
      color: var(--green);
      display: block;
      margin-bottom: 4px;
      text-shadow: 0 0 5px var(--green);
    }
    .stat-box span.label {
      font-size: 12px;
      font-weight: 600;
      color: #334155;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    #vips-container {
      width: 100%;
      max-width: 720px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
      padding: 0 var(--padding);
      box-sizing: border-box;
    }
    .vip-card {
      background: linear-gradient(145deg, var(--card-gradient-start), var(--card-gradient-end));
      border-radius: var(--radius);
      box-shadow: 6px 6px 12px #bebebe, -6px -6px 12px #ffffff;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      user-select: none;
      color: #1e293b;
      transition: box-shadow 0.3s ease;
      backdrop-filter: blur(6px);
      border: 1px solid rgba(255,255,255,0.25);
    }
    .vip-card:hover {
      box-shadow: 8px 8px 16px #9a9a9a, -8px -8px 16px #ffffff;
    }
    .vip-header {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .vip-logo {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background-size: cover;
      background-position: center;
      font-weight: 900;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: var(--green);
      box-shadow: 0 2px 8px rgba(97,182,4,0.3);
      flex-shrink: 0;
      color: var(--white);
      transition: transform 0.3s ease;
    }
    .vip-card:hover .vip-logo {
      transform: scale(1.1);
    }
    .vip-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: #111827;
      text-shadow: 0 0 4px rgba(0,0,0,0.15);
    }
    .vip-subtitle {
      font-size: 0.75rem;
      color: #4b5563;
      margin-top: 2px;
      text-shadow: 0 0 3px rgba(255,255,255,0.5);
    }
    .vip-details {
      border-top: 1px solid #e5e7eb;
      padding-top: 8px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px 12px;
      font-size: 0.8rem;
      color: #334155;
    }
    .detail-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .detail-row i {
      color: #6b7280;
      margin-right: 6px;
      text-shadow: 0 0 2px rgba(255,255,255,0.7);
    }
    .progress-container {
      margin-top: 10px;
    }
    .progress-header {
      display: flex;
      justify-content: space-between;
      font-weight: 600;
      font-size: 0.8rem;
      color: #334155;
      margin-bottom: 4px;
    }
    .progress-bar {
      background: var(--gray-medium);
      border-radius: 8px;
      height: 12px;
      overflow: hidden;
      box-shadow: inset 0 1px 3px rgb(0 0 0 / 0.1);
    }
    .progress-fill {
      background: var(--green);
      height: 100%;
      transition: width 1s ease-in-out;
      box-shadow: 0 0 6px var(--green);
    }
    /* Les boutons ne sont pas modifi√©s comme demand√© */

    /* Notification */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 18px;
      border-radius: var(--radius);
      font-weight: 600;
      font-size: 0.85rem;
      z-index: 10000;
      display: none;
      user-select: none;
      box-shadow: 0 8px 18px rgb(0 0 0 / 0.25);
      color: var(--white);
    }
    .notification.success {
      background-color: #22c55e;
    }
    .notification.error {
      background-color: #ef4444;
    }

    /* Bottom nav fixe */
    nav.bottom-nav {
      position: fixed;
      bottom: 0;
      width: 100%;
      z-index: 1000;
      margin-top: auto;
      display: flex;
      background-color: var(--green);
      color: var(--white);
      font-weight: 700;
      font-size: 16px;
      border-radius: var(--radius) var(--radius) 0 0;
      overflow: hidden;
      user-select: none;
    }
    nav.bottom-nav a {
      flex: 1;
      text-align: center;
      padding: 14px 0;
      cursor: pointer;
      transition: background-color 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      color: inherit;
      text-decoration: none;
    }
    nav.bottom-nav a.active {
      background-color: var(--white);
      color: var(--green);
      border-radius: var(--radius) var(--radius) 0 0;
    }
    nav.bottom-nav a:not(.active):hover {
      background-color: #87d544;
    }
    nav.bottom-nav svg {
      width: 24px;
      height: 24px;
      fill: currentColor;
    }
    /* Responsive */
    @media (max-width: 400px) {
      #vips-container {
        grid-template-columns: 1fr;
        padding: 0 10px;
      }
      .stat-box {
        padding: 10px 12px;
        min-width: 100px;
      }
      .vip-title {
        font-size: 1rem;
      }
      .vip-subtitle {
        font-size: 0.7rem;
      }
      button.collect-btn {
        padding: 8px 0;
        font-size: 0.8rem;
      }
    }
  </style>
</head>
<body>

  <header>
    <h1>Suivez votre revenu ici</h1>
    <p>Vous pouvez suivre votre investissement chaque 24/24</p>
  </header>

  <section class="stats" aria-label="Statistiques des VIPs">
    <div class="stat-box" role="region" aria-live="polite">
      <span id="total-vips" class="number">0</span>
      <span class="label">Nombre d'articles</span>
    </div>
    <div class="stat-box" role="region" aria-live="polite">
      <span id="total-revenue" class="number">0 FCFA</span>
      <span class="label">B√©n√©fice gagn√©</span>
    </div>
  </section>

  <main id="vips-container" aria-live="polite" aria-label="Liste des VIPs investis">
    <!-- Cartes VIP rendues ici -->
  </main>

  <div class="notification" role="alert" aria-live="assertive"></div>

  <nav class="bottom-nav" role="navigation" aria-label="Navigation principale">
    <a href="accueil.html" class="active" aria-current="page">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
      Accueil
    </a>
    <a href="appareil.html">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 6H4v12h16V6z"/></svg>
      Article
    </a>
    <a href="equipe.html">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4z"/></svg>
      √âquipe
    </a>
    <a href="solde.html">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4v-1H8v1c0 2.21 1.79 4 4 4z"/></svg>
      Moi
    </a>
  </nav>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword
  } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
  import {
    getDatabase,
    ref,
    get,
    set,
    update,
    onValue
  } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

  // üî• Configuration Firebase (PEPECO)
  const firebaseConfig = {
    apiKey: "AIzaSyCaDZQUirunG7CPrMISasgBVlVgkyuISko",
    authDomain: "pepeco-f6f26.firebaseapp.com",
    databaseURL: "https://pepeco-f6f26-default-rtdb.firebaseio.com",
    projectId: "pepeco-f6f26",
    storageBucket: "pepeco-f6f26.firebasestorage.app",
    messagingSenderId: "175958489677",
    appId: "1:175958489677:web:48b339d732e4207d0f7a04"
  };

  // Initialisation Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);
  let currentUser = null;

  // ‚öôÔ∏è Configuration des articles (VIP)
  const VIP_CONFIG = {
    1: { nom: "Chaussures", dailyRevenue: 380, cycleDuration: 70, totalRevenue: 26600, image: "https://image.noelshack.com/fichiers/2025/41/6/1760179383-mocassin-ete-cuir-graine-marron-pour-homme-503br-2.jpg" },
    2: { nom: "Habille", dailyRevenue: 900, cycleDuration: 70, totalRevenue: 63000, image: "https://image.noelshack.com/fichiers/2025/41/6/1760179492-nature-morte-chemises-classiques-cintre-23-2150828629.jpg" },
    3: { nom: "Chapeau", dailyRevenue: 3100, cycleDuration: 70, totalRevenue: 217000, image: "https://image.noelshack.com/fichiers/2025/41/6/1760179668-images-2.jpeg" },
    5: { nom: "Sac", dailyRevenue: 7100, cycleDuration: 70, totalRevenue: 497000, image: "https://image.noelshack.com/fichiers/2025/41/6/1760179812-whatsappimage2024-02-26at14-05-37-2-1024x1024.jpg" },
    6: { nom: "Cravate", dailyRevenue: 18100, cycleDuration: 70, totalRevenue: 1267000, image: "https://image.noelshack.com/fichiers/2025/41/6/1760179910-une-cravate-sur-le-fond-blanc-17205221.jpg" },
    7: { nom: "Montre", dailyRevenue: 48100, cycleDuration: 70, totalRevenue: 8450000, image: "https://image.noelshack.com/fichiers/2025/41/6/1760180029-550x548.jpg" },
  };

  // ‚úÖ Fonction pour afficher une notification
  function showNotification(message, type = "info") {
    const notification = document.querySelector('.notification');
    if (!notification) return;
    notification.textContent = message;
    notification.className = `notification ${type}`;
    notification.style.display = 'block';
    setTimeout(() => notification.style.display = 'none', 3000);
  }

  // üìä Calcul de la progression du cycle
  function calculateCycleProgress(investment) {
    const config = VIP_CONFIG[investment.productId];
    if (!config) return { isComplete: true, progress: 100, remainingDays: 0 };

    const totalCollected = investment.totalCollected || 0;
    const progress = Math.min(Math.round((totalCollected / config.totalRevenue) * 100), 100);
    const daysInCycle = Math.floor((Date.now() - (investment.timestamp || Date.now())) / (1000 * 60 * 60 * 24));
    const remainingDays = Math.max(0, config.cycleDuration - daysInCycle);

    return {
      isComplete: totalCollected >= config.totalRevenue,
      progress,
      remainingDays
    };
  }

  // üìÖ V√©rifie si l'utilisateur peut collecter aujourd‚Äôhui
  function isReadyToCollect(investment) {
    const lastCollection = investment.lastCollection || 0;
    const now = new Date();
    const lastDate = new Date(lastCollection);
    return (
      now.getDate() !== lastDate.getDate() ||
      now.getMonth() !== lastDate.getMonth() ||
      now.getFullYear() !== lastDate.getFullYear()
    );
  }

  // üìà Mise √† jour des statistiques globales
  function updateStats(investments) {
    const totalVips = investments.filter(inv => inv.status === 'active').length;
    const totalRevenueNum = investments.reduce((sum, inv) => sum + (inv.status === 'active' ? (inv.totalCollected || 0) : 0), 0);
    const totalVipsElement = document.getElementById('total-vips');
    const totalRevenueElement = document.getElementById('total-revenue');

    if (totalVipsElement) totalVipsElement.textContent = totalVips;
    if (totalRevenueElement) totalRevenueElement.textContent = totalRevenueNum.toLocaleString('fr-FR') + ' FCFA';
  }

  // üîÑ Chargement des articles actifs
  async function loadVIPs() {
    if (!currentUser) return;
    try {
      const snapshot = await get(ref(db, `investments/${currentUser.uid}`));
      const container = document.getElementById('vips-container');
      if (!container) return console.error("√âl√©ment 'vips-container' non trouv√©");

      if (!snapshot.exists()) {
        container.innerHTML = `<div class="no-vip">Aucun article actif. Investissez pour commencer √† gagner.</div>`;
        updateStats([]);
        return;
      }

      const investments = [];
      snapshot.forEach(child => {
        const investment = { id: child.key, ...child.val() };
        if (investment.status === 'active') investments.push(investment);
      });

      updateStats(investments);
      renderVIPs(investments);
    } catch (error) {
      console.error("Erreur lors du chargement:", error);
      showNotification("Erreur lors du chargement des articles", "error");
    }
  }

  // üñºÔ∏è Affichage des articles (VIP)
  function renderVIPs(investments) {
    const container = document.getElementById('vips-container');
    if (!container) return;

    if (investments.length === 0) {
      container.innerHTML = `<div class="no-vip">Aucun article actif.</div>`;
      return;
    }

    container.innerHTML = investments.map(investment => {
      const config = VIP_CONFIG[investment.productId];
      if (!config) return '';
      const { isComplete, progress, remainingDays } = calculateCycleProgress(investment);
      const canCollect = !isComplete && isReadyToCollect(investment);
      const formattedDate = new Date(investment.timestamp).toLocaleDateString('fr-FR');

      return `
        <div class="vip-card">
          <div class="vip-header">
            <div class="vip-logo" style="background-image: url('${config.image}');"></div>
            <div>
              <div class="vip-title">${config.nom}</div>
              <div class="vip-subtitle">${config.dailyRevenue.toLocaleString('fr-FR')} FCFA / jour</div>
            </div>
          </div>
          <div class="vip-details">
            <div><i class="fas fa-calendar"></i> ${formattedDate}</div>
            <div><i class="fas fa-clock"></i> ${remainingDays} jours restants</div>
            <div><i class="fas fa-wallet"></i> ${config.dailyRevenue.toLocaleString('fr-FR')} FCFA</div>
          </div>
          <div class="progress-container">
            <div class="progress-header"><span>Progression</span><span>${progress}%</span></div>
            <div class="progress-bar"><div class="progress-fill" style="width: ${progress}%"></div></div>
          </div>
          <button class="collect-btn" 
                  onclick="window.collectRevenue('${investment.id}')" 
                  ${(!canCollect || isComplete) ? 'disabled' : ''}>
            ${isComplete ? 'Cycle termin√©' : (canCollect ? 'Collecter les revenus' : 'D√©j√† collect√©')}
          </button>
        </div>
      `;
    }).join('');
  }

  // üí∞ Fonction de collecte des revenus journaliers
  window.collectRevenue = async function (investmentId) {
    if (!currentUser) return showNotification("Veuillez vous connecter", "error");

    try {
      const investmentRef = ref(db, `investments/${currentUser.uid}/${investmentId}`);
      const userRef = ref(db, `users/${currentUser.uid}`);
      const [investmentSnapshot, userSnapshot] = await Promise.all([get(investmentRef), get(userRef)]);

      if (!investmentSnapshot.exists() || !userSnapshot.exists()) throw new Error("Donn√©es manquantes");

      const investment = investmentSnapshot.val();
      const user = userSnapshot.val();
      const config = VIP_CONFIG[investment.productId];
      if (!config) throw new Error("Article non reconnu");

      const { isComplete } = calculateCycleProgress(investment);
      if (isComplete) throw new Error("Cycle termin√©");
      if (!isReadyToCollect(investment)) throw new Error("D√©j√† collect√© aujourd‚Äôhui");

      const newTotal = (investment.totalCollected || 0) + config.dailyRevenue;
      if (newTotal > config.totalRevenue) throw new Error("Cycle termin√©");

      const updates = {
        [`users/${currentUser.uid}/balance`]: (user.balance || 0) + config.dailyRevenue,
        [`investments/${currentUser.uid}/${investmentId}/lastCollection`]: Date.now(),
        [`investments/${currentUser.uid}/${investmentId}/totalCollected`]: newTotal
      };
      await update(ref(db), updates);

      showNotification(`+${config.dailyRevenue.toLocaleString('fr-FR')} FCFA collect√© !`, "success");
      loadVIPs();
    } catch (error) {
      console.error("Erreur:", error);
      showNotification(error.message, "error");
    }
  };

  // üë§ Suivi de l‚Äô√©tat de connexion
  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUser = user;
      loadVIPs();
      onValue(ref(db, `investments/${user.uid}`), () => loadVIPs());
    } else {
      window.location.href = 'login.html';
    }
  });

  // ‚ö†Ô∏è Gestion des erreurs globales
  window.addEventListener('error', (e) => {
    console.error('Erreur globale:', e);
    showNotification('Erreur inattendue', "error");
  });

  window.addEventListener('unhandledrejection', (e) => {
    console.error('Erreur promesse:', e.reason);
    showNotification('Erreur inattendue', "error");
    e.preventDefault();
  });
</script>

</body>
</html>
